<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Generator</title>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        h1 {
            text-align: center;
            color: #333;
        }
        
        .input-container {
            margin-bottom: 20px;
        }
        
        #url-input {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            outline: none;
            transition: border-color 0.3s;
        }
        
        #url-input:focus {
            border-color: #007bff;
        }
        
        .qr-container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            margin-bottom: 20px;
        }
        
        #qr-code {
            display: inline-block;
            min-height: 200px;
            min-width: 200px;
        }
        
        #qr-code svg {
            max-width: 100%;
            height: auto;
        }
        
        .placeholder {
            color: #999;
            font-size: 14px;
            padding: 80px 20px;
        }
        
        .button-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        button {
            padding: 12px 24px;
            font-size: 14px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
        }
        
        button:hover {
            transform: translateY(-1px);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        #copy-btn {
            background-color: #28a745;
            color: white;
        }
        
        #copy-btn:hover {
            background-color: #218838;
        }
        
        #save-btn {
            background-color: #007bff;
            color: white;
        }
        
        #save-btn:hover {
            background-color: #0056b3;
        }
        
        #format-select {
            padding: 12px;
            font-size: 14px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
            cursor: pointer;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 24px;
            background-color: #28a745;
            color: white;
            border-radius: 8px;
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s, transform 0.3s;
            z-index: 1000;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .button-container {
                flex-direction: column;
            }
            
            button, #format-select {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <h1>QR Code Generator</h1>
    
    <div class="input-container">
        <input type="url" id="url-input" placeholder="Enter URL here (e.g., https://example.com)" autocomplete="off">
    </div>
    
    <div class="qr-container">
        <div id="qr-code">
            <div class="placeholder">Enter a URL above to generate a QR code</div>
        </div>
    </div>
    
    <div class="button-container">
        <button id="copy-btn" disabled>Copy SVG</button>
        <select id="format-select">
            <option value="svg">SVG</option>
            <option value="png">PNG</option>
            <option value="jpg">JPG</option>
            <option value="pdf">PDF</option>
        </select>
        <button id="save-btn" disabled>Save Image</button>
    </div>
    
    <div id="notification" class="notification"></div>

    <!-- QR Code generator library (local) -->
    <script src="lib/qrcode-generator.min.js"></script>
    <!-- jsPDF loaded lazily when needed for PDF export -->
    
    <script>
        const urlInput = document.getElementById('url-input');
        const qrCodeContainer = document.getElementById('qr-code');
        const copyBtn = document.getElementById('copy-btn');
        const saveBtn = document.getElementById('save-btn');
        const formatSelect = document.getElementById('format-select');
        const notification = document.getElementById('notification');
        
        let currentSvgString = null;
        let debounceTimer = null;
        let jsPDFLoaded = false;
        
        // Lazy load jsPDF when needed
        async function loadJsPDF() {
            if (jsPDFLoaded) return;
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'lib/jspdf.umd.min.js';
                script.onload = () => {
                    jsPDFLoaded = true;
                    resolve();
                };
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }
        
        // Show notification
        function showNotification(message, isError = false) {
            notification.textContent = message;
            notification.style.backgroundColor = isError ? '#dc3545' : '#28a745';
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 2000);
        }
        
        // Generate QR code as SVG
        function generateQRCodeSVG(text) {
            const qr = qrcode(0, 'M');
            qr.addData(text);
            qr.make();
            
            const moduleCount = qr.getModuleCount();
            const cellSize = 8;
            const margin = 16;
            const size = moduleCount * cellSize + margin * 2;
            
            let svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">`;
            svg += `<rect width="100%" height="100%" fill="white"/>`;
            
            for (let row = 0; row < moduleCount; row++) {
                for (let col = 0; col < moduleCount; col++) {
                    if (qr.isDark(row, col)) {
                        const x = col * cellSize + margin;
                        const y = row * cellSize + margin;
                        svg += `<rect x="${x}" y="${y}" width="${cellSize}" height="${cellSize}" fill="black"/>`;
                    }
                }
            }
            
            svg += '</svg>';
            return svg;
        }
        
        // Generate QR code
        function generateQRCode(url) {
            if (!url) {
                qrCodeContainer.innerHTML = '<div class="placeholder">Enter a URL above to generate a QR code</div>';
                copyBtn.disabled = true;
                saveBtn.disabled = true;
                currentSvgString = null;
                return;
            }
            
            try {
                currentSvgString = generateQRCodeSVG(url);
                
                qrCodeContainer.innerHTML = currentSvgString;
                copyBtn.disabled = false;
                saveBtn.disabled = false;
            } catch (error) {
                qrCodeContainer.innerHTML = '<div class="placeholder">Error generating QR code</div>';
                copyBtn.disabled = true;
                saveBtn.disabled = true;
                currentSvgString = null;
                console.error('QR generation error:', error);
            }
        }
        
        // Debounced input handler
        urlInput.addEventListener('input', () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                generateQRCode(urlInput.value.trim());
            }, 300);
        });
        
        // Copy SVG to clipboard
        copyBtn.addEventListener('click', async () => {
            if (!currentSvgString) return;
            
            try {
                await navigator.clipboard.writeText(currentSvgString);
                showNotification('SVG copied to clipboard!');
            } catch (error) {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = currentSvgString;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showNotification('SVG copied to clipboard!');
            }
        });
        
        // Convert SVG to Canvas for raster exports
        function svgToCanvas(svgString, width, height) {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                
                // Fill white background
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, width, height);
                
                const img = new Image();
                const svgBlob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
                const url = URL.createObjectURL(svgBlob);
                
                img.onload = () => {
                    ctx.drawImage(img, 0, 0, width, height);
                    URL.revokeObjectURL(url);
                    resolve(canvas);
                };
                
                img.onerror = () => {
                    URL.revokeObjectURL(url);
                    reject(new Error('Failed to load SVG'));
                };
                
                img.src = url;
            });
        }
        
        // Download file
        function downloadFile(data, filename, mimeType) {
            const blob = new Blob([data], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
        
        // Save image in selected format
        saveBtn.addEventListener('click', async () => {
            if (!currentSvgString) return;
            
            const format = formatSelect.value;
            const filename = 'qrcode';
            
            try {
                switch (format) {
                    case 'svg':
                        downloadFile(currentSvgString, `${filename}.svg`, 'image/svg+xml');
                        showNotification('SVG downloaded!');
                        break;
                        
                    case 'png': {
                        const canvas = await svgToCanvas(currentSvgString, 512, 512);
                        canvas.toBlob((blob) => {
                            const url = URL.createObjectURL(blob);
                            const link = document.createElement('a');
                            link.href = url;
                            link.download = `${filename}.png`;
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            URL.revokeObjectURL(url);
                            showNotification('PNG downloaded!');
                        }, 'image/png');
                        break;
                    }
                        
                    case 'jpg': {
                        const canvas = await svgToCanvas(currentSvgString, 512, 512);
                        canvas.toBlob((blob) => {
                            const url = URL.createObjectURL(blob);
                            const link = document.createElement('a');
                            link.href = url;
                            link.download = `${filename}.jpg`;
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            URL.revokeObjectURL(url);
                            showNotification('JPG downloaded!');
                        }, 'image/jpeg', 0.95);
                        break;
                    }
                        
                    case 'pdf': {
                        await loadJsPDF();
                        const canvas = await svgToCanvas(currentSvgString, 512, 512);
                        const { jsPDF } = window.jspdf;
                        const pdf = new jsPDF({
                            orientation: 'portrait',
                            unit: 'mm',
                            format: [80, 80]
                        });
                        
                        const imgData = canvas.toDataURL('image/png');
                        pdf.addImage(imgData, 'PNG', 5, 5, 70, 70);
                        pdf.save(`${filename}.pdf`);
                        showNotification('PDF downloaded!');
                        break;
                    }
                }
            } catch (error) {
                showNotification('Error saving image', true);
                console.error('Save error:', error);
            }
        });
    </script>
</body>
</html>
